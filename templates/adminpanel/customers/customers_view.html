{% extends 'adminpanel/dashboard.html' %}

{% block title %}User Management | GameWear Admin{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto relative">
    
    <!-- Back Button & Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
        <div>
            <a href="{% url 'adminpanel:customers_list' %}" class="flex items-center text-neutral-400 hover:text-white transition text-sm mb-4 group">
                <svg class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Customer List
            </a>
            <div class="flex items-center gap-4">
                <!-- Profile Image / Initials -->
                <div class="w-16 h-16 rounded-2xl bg-neutral-900 border border-neutral-800 flex items-center justify-center text-xl font-bold text-white uppercase overflow-hidden">
                    {% if customer.profile_image %}
                        <img src="{{ customer.profile_image.url }}" alt="{{ customer.username }}" class="w-full h-full object-cover">
                    {% else %}
                        {% if customer.first_name %}
                            {{ customer.first_name|slice:":1" }}{{ customer.last_name|slice:":1" }}
                        {% else %}
                            {{ customer.username|slice:":2" }}
                        {% endif %}
                    {% endif %}
                </div>
                <div>
                    <h1 class="text-3xl font-bold">{{ customer.get_full_name|default:customer.full_name }}</h1>
                    <p class="text-neutral-500 font-mono text-sm">Customer ID: #{{ customer_index }}</p>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <a href="#" class="bg-neutral-900 text-white border border-neutral-800 px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-neutral-800 transition">
                Edit Profile
            </a>

            <!-- BLOCK / UNBLOCK BUTTONS (Trigger Modal) -->
            {% if customer.is_active %}
                <!-- Button for Blocking -->
                <button type="button" 
                        onclick="openConfirmationModal('{% url 'adminpanel:block_user' customer.id %}', 'block')"
                        class="bg-red-950/30 text-red-500 border border-red-900/50 px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-red-900/40 transition">
                    Block User
                </button>
            {% else %}
                <!-- Button for Unblocking -->
                <button type="button" 
                        onclick="openConfirmationModal('{% url 'adminpanel:unblock_user' customer.id %}', 'unblock')"
                        class="bg-green-950/30 text-green-500 border border-green-900/50 px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-green-900/40 transition">
                    Unblock User
                </button>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- LEFT COLUMN: USER INFO -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Wallet Card -->
            <div class="card-gradient border border-neutral-900 rounded-2xl p-6 shadow-xl relative overflow-hidden bg-gradient-to-br from-neutral-800 to-black">
                <div class="relative z-10">
                    <p class="text-neutral-500 text-xs font-bold uppercase tracking-widest mb-1">Wallet Balance</p>
                    <h2 class="text-4xl font-black text-white">
                        ${{ customer.wallet.balance|default:"0.00" }}
                    </h2>
                    <div class="mt-4 flex gap-2">
                        <button class="bg-white/10 hover:bg-white/20 text-white text-[10px] font-bold py-1 px-3 rounded-full transition">Add Funds</button>
                        <button class="bg-white/5 hover:bg-white/10 text-neutral-400 text-[10px] font-bold py-1 px-3 rounded-full transition">View Logs</button>
                    </div>
                </div>
                <div class="absolute -right-8 -bottom-8 w-32 h-32 bg-white/5 rounded-full blur-3xl"></div>
            </div>

            <!-- Info Details -->
            <div class="bg-black border border-neutral-900 rounded-2xl p-6 space-y-6">
                <h3 class="text-sm font-bold text-white border-b border-neutral-900 pb-3">User Information</h3>
                
                <div>
                    <label class="block text-[10px] font-bold text-neutral-500 uppercase mb-1">Email Address</label>
                    <p class="text-sm text-white">{{ customer.email }}</p>
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-neutral-500 uppercase mb-1">Phone Number</label>
                    <p class="text-sm text-white">{{ customer.phone_number|default:"Not Provided" }}</p>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-neutral-500 uppercase mb-1">Account Status</label>
                    {% if customer.is_active %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold bg-green-900/20 text-green-400 border border-green-900/50 mt-1">
                        ACTIVE
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold bg-red-900/10 text-red-500/70 border border-red-900/30 mt-1">
                        INACTIVE
                    </span>
                    {% endif %}
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-neutral-500 uppercase mb-1">Member Since</label>
                    <p class="text-sm text-white">{{ customer.created_at|date:"F d, Y"|default:"N/A" }}</p>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-neutral-500 uppercase mb-1">Last Login</label>
                    <p class="text-sm text-neutral-400 italic">
                        {% if customer.last_login %}
                            {{ customer.last_login|timesince }} ago
                        {% else %}
                            Never logged in
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: ORDER HISTORY -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-black border border-neutral-900 rounded-2xl overflow-hidden shadow-2xl">
                <div class="p-6 border-b border-neutral-900 flex justify-between items-center">
                    <h3 class="text-lg font-bold">Order History</h3>
                    <span class="text-xs text-neutral-500">{{ customer.order_set.count|default:"0" }} Total Orders</span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-[10px] text-neutral-500 bg-neutral-900/30 uppercase border-b border-neutral-900">
                            <tr>
                                <th class="px-6 py-3 font-bold">Order ID</th>
                                <th class="px-6 py-3 font-bold">Date</th>
                                <th class="px-6 py-3 font-bold">Items</th>
                                <th class="px-6 py-3 font-bold">Total</th>
                                <th class="px-6 py-3 font-bold">Status</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-neutral-900">
                            {% for order in customer.order_set.all|slice:":5" %}
                            <tr class="hover:bg-neutral-900/20 transition-colors">
                                <td class="px-6 py-4 font-mono text-xs text-white">#{{ order.id|stringformat:"04d" }}</td>
                                <td class="px-6 py-4 text-neutral-400">{{ order.created_at|date:"M d, Y" }}</td>
                                <td class="px-6 py-4 text-neutral-400">{{ order.items_summary|default:"Order Items" }}</td>
                                <td class="px-6 py-4 font-bold text-white">${{ order.total_price }}</td>
                                <td class="px-6 py-4">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded 
                                        {% if order.status == 'SHIPPED' %}text-blue-400 bg-blue-900/10
                                        {% elif order.status == 'DELIVERED' %}text-green-400 bg-green-900/10
                                        {% else %}text-neutral-400 bg-neutral-900/10{% endif %}">
                                        {{ order.status|upper }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-neutral-500 italic">No orders found for this customer.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if customer.order_set.count > 5 %}
                <div class="p-4 bg-neutral-900/10 text-center">
                    <a href="#" class="text-xs font-bold text-neutral-500 hover:text-white transition">View All Orders</a>
                </div>
                {% endif %}
            </div>

            <!-- Quick Actions Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button class="bg-black border border-neutral-900 p-4 rounded-xl flex items-center hover:bg-neutral-900 transition group text-left">
                    <div class="w-10 h-10 rounded-lg bg-neutral-900 border border-neutral-800 flex items-center justify-center mr-3 group-hover:scale-110 transition">
                        <svg class="w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm font-bold">Send Message</p>
                        <p class="text-[10px] text-neutral-500">DM to {{ customer.first_name|default:customer.full_name }}'s inbox</p>
                    </div>
                </button>
                <button class="bg-black border border-neutral-900 p-4 rounded-xl flex items-center hover:bg-neutral-900 transition group text-left">
                    <div class="w-10 h-10 rounded-lg bg-neutral-900 border border-neutral-800 flex items-center justify-center mr-3 group-hover:scale-110 transition">
                        <svg class="w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm font-bold">Security Reset</p>
                        <p class="text-[10px] text-neutral-500">Force password reset</p>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CONFIRMATION MODAL -->
<div id="statusModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <!-- Modal Panel -->
            <div class="relative transform overflow-hidden rounded-2xl bg-neutral-900 border border-neutral-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md scale-95 opacity-0" id="modalPanel">
                <div class="p-6">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-neutral-800" id="modalIconContainer">
                            <!-- Icon injected via JS -->
                            <svg class="h-6 w-6 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" id="modalIcon">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.008v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-1">
                            <h3 class="text-lg font-bold leading-6 text-white" id="modalTitle">Confirm Action</h3>
                            <div class="mt-2">
                                <p class="text-sm text-neutral-400" id="modalMessage">Are you sure you want to perform this action?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-black/50 px-6 py-4 flex flex-row-reverse gap-3">
                    <form id="modalForm" method="POST">
                        {% csrf_token %}
                        <button type="submit" id="modalConfirmBtn" class="inline-flex w-full justify-center rounded-lg px-5 py-2.5 text-sm font-bold text-white shadow-sm hover:bg-red-500 sm:w-auto transition">
                            Confirm
                        </button>
                    </form>
                    <button type="button" onclick="closeConfirmationModal()" class="mt-3 inline-flex w-full justify-center rounded-lg bg-transparent px-5 py-2.5 text-sm font-bold text-neutral-400 hover:bg-neutral-800 hover:text-white sm:mt-0 sm:w-auto transition border border-transparent hover:border-neutral-700">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple Vanilla JS for Modal Control
    function openConfirmationModal(url, actionType) {
        const modal = document.getElementById('statusModal');
        const backdrop = document.getElementById('modalBackdrop');
        const panel = document.getElementById('modalPanel');
        const form = document.getElementById('modalForm');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const icon = document.getElementById('modalIcon');
        const iconContainer = document.getElementById('modalIconContainer');

        // Set Form Action
        form.action = url;

        // Customize Content based on Action
        if (actionType === 'block') {
            title.textContent = 'Block User?';
            message.textContent = 'Are you sure you want to block this user? They will not be able to log in or make purchases.';
            confirmBtn.textContent = 'Block User';
            
            // Red Styling
            confirmBtn.className = "inline-flex w-full justify-center rounded-lg px-5 py-2.5 text-sm font-bold text-white shadow-sm bg-red-600 hover:bg-red-500 sm:w-auto transition";
            iconContainer.className = "flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/30";
            icon.className = "h-6 w-6 text-red-500";
            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.008v.008H12v-.008z" />';
        } else {
            title.textContent = 'Unblock User?';
            message.textContent = 'This will restore the user\'s access to the platform. Are you sure?';
            confirmBtn.textContent = 'Unblock User';

            // Green Styling
            confirmBtn.className = "inline-flex w-full justify-center rounded-lg px-5 py-2.5 text-sm font-bold text-white shadow-sm bg-green-600 hover:bg-green-500 sm:w-auto transition";
            iconContainer.className = "flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-900/30";
            icon.className = "h-6 w-6 text-green-500";
            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
        }

        // Show Modal with Animation
        modal.classList.remove('hidden');
        // Small timeout to allow browser to render 'hidden' removal before animating opacity
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('scale-95', 'opacity-0');
            panel.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeConfirmationModal() {
        const modal = document.getElementById('statusModal');
        const backdrop = document.getElementById('modalBackdrop');
        const panel = document.getElementById('modalPanel');

        // Reverse Animation
        backdrop.classList.add('opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
        panel.classList.add('scale-95', 'opacity-0');

        // Hide after animation finishes (300ms)
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // Close on click outside
    window.onclick = function(event) {
        const modal = document.getElementById('statusModal');
        const backdrop = document.getElementById('modalBackdrop');
        if (event.target == backdrop) {
            closeConfirmationModal();
        }
    }
</script>

{% endblock %}