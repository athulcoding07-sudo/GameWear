{% extends "users/user_dashboard_base.html" %}

{% block title %}GameWear - Address Book{% endblock %}

{% block content %}
<!-- Profile Hero -->
<div class="flex flex-col md:flex-row items-center gap-8 mb-12 pb-12 border-b border-neutral-900">
    <div class="relative">
        <div class="w-32 h-32 rounded-3xl bg-neutral-800 flex items-center justify-center overflow-hidden border-2 border-neutral-700">
            <img
                src="{% if user.profile_image %}{{ user.profile_image.url }}{% else %}https://api.dicebear.com/7.x/avataaars/svg?seed={{ user.get_full_name|default:user.username }}{% endif %}"
                alt="Avatar"
                class="w-full h-full object-cover"
            >
        </div>
    </div>

    <div class="text-center md:text-left flex-grow">
        <h1 class="text-4xl font-black uppercase tracking-tighter italic">{{ request.user.full_name }}</h1>
        <p class="text-neutral-500 font-medium uppercase text-[10px] tracking-widest mt-1">Pro Member <span class="mx-2 text-neutral-800">|</span> GW-UID-9928</p>
        <div class="flex gap-4 mt-6 justify-center md:justify-start">
            <button class="border border-neutral-800 text-neutral-500 px-6 py-2.5 rounded-lg font-black text-[10px] uppercase tracking-widest hover:bg-neutral-900 hover:text-white transition">Sign Out</button>
        </div>
    </div>
    
    <div class="w-full md:w-auto bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
        <p class="text-[10px] font-black uppercase text-neutral-500 tracking-widest mb-3">Saved Addresses</p>
        <h3 class="text-3xl font-black italic tracking-tighter">{{ addresses|length|default:"0" }}</h3>
    </div>
</div>

<div class="flex flex-col lg:flex-row gap-12">
    <!-- Sidebar Navigation -->
    <aside class="w-full lg:w-64 flex-shrink-0">
        <nav class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-visible pb-4 lg:pb-0 no-scrollbar">
            <a href="{% url 'users:user_profile' %}" class="px-6 py-4 rounded-xl text-neutral-500 hover:bg-neutral-900 hover:text-white font-black uppercase text-[10px] tracking-widest flex items-center gap-3 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                Account
            </a>
            <a href="#" class="px-6 py-4 rounded-xl text-neutral-500 hover:bg-neutral-900 hover:text-white font-black uppercase text-[10px] tracking-widest flex items-center gap-3 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                Orders
            </a>
            <a href="#" class="px-6 py-4 rounded-xl text-neutral-500 hover:bg-neutral-900 hover:text-white font-black uppercase text-[10px] tracking-widest flex items-center gap-3 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                Wallet
            </a>
            <a href="#" class="px-6 py-4 rounded-xl bg-white text-black font-black uppercase text-[10px] tracking-widest flex items-center gap-3 transition shadow-xl">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Address
            </a>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <section class="flex-grow">
        <div class="bg-neutral-950 border border-neutral-900 rounded-3xl p-8">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-xl font-black uppercase tracking-tighter italic">Address Book</h2>
                <button onclick="openModal('addAddressModal')" 
                        class="bg-white text-black font-black uppercase text-[10px] tracking-widest px-6 py-3 rounded-xl hover:bg-neutral-200 transition shadow-lg flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Address
                </button>
            </div>

            {% if addresses %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for address in addresses %}
                <div class="bg-black border border-neutral-800 rounded-2xl p-6 relative group hover:border-neutral-500 transition">
                    {% if address.is_default %}
                    <span class="absolute top-4 right-4 text-[9px] font-black uppercase tracking-widest bg-white text-black px-2 py-0.5 rounded">Default</span>
                    {% endif %}
                    
                    <p class="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-3">{{ address.full_name }}</p>
                    <div class="text-neutral-300 text-sm space-y-1 font-medium leading-relaxed mb-6">
                        <p>{{ address.address_line_1 }}</p>
                        {% if address.address_line_2 %}<p>{{ address.address_line_2 }}</p>{% endif %}
                        <p>{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                        <p class="text-neutral-600 uppercase text-[9px] tracking-widest pt-2">{{ address.country }}</p>
                        <p class="text-neutral-400 font-mono text-[11px]">{{ address.phone }}</p>
                    </div>

                    <div class="flex gap-3 pt-4 border-t border-neutral-900">
                        <button onclick="openEditModal(
                            '{{ address.id }}',
                            '{{ address.full_name|escapejs }}',
                            '{{ address.phone|escapejs }}',
                            '{{ address.address_line_1|escapejs }}',
                            '{{ address.address_line_2|escapejs }}',
                            '{{ address.city|escapejs }}',
                            '{{ address.state|escapejs }}',
                            '{{ address.postal_code|escapejs }}',
                            '{{ address.country|escapejs }}',
                            '{{ address.is_default }}'
                        )"
                        class="flex-1 text-[9px] font-black uppercase tracking-widest text-neutral-400 hover:text-white transition text-left">Edit</button>
                        <button onclick="openDeleteModal('{{ address.id }}')" 
                                class="text-[9px] font-black uppercase tracking-widest text-rose-900 hover:text-rose-500 transition">Delete</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-20 bg-black/50 border-2 border-dashed border-neutral-900 rounded-3xl">
                <p class="text-neutral-600 font-black uppercase text-[10px] tracking-[0.3em]">No saved locations found</p>
                <button onclick="openModal('addAddressModal')" class="mt-6 text-white underline underline-offset-8 font-black uppercase text-[10px] tracking-widest hover:text-neutral-400 transition">Add your first address</button>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- ================= MODALS ================= -->

<!-- ADD ADDRESS MODAL -->
<div id="addAddressModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-modal="true">
    <div class="fixed inset-0 bg-black/95 backdrop-blur-sm transition-opacity" onclick="closeModal('addAddressModal')"></div>
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="relative bg-neutral-950 border border-neutral-800 rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-8 border-b border-neutral-900 flex justify-between items-center">
                <h3 class="text-lg font-black uppercase tracking-tighter italic">New Location</h3>
                <button onclick="closeModal('addAddressModal')" class="text-neutral-500 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form method="POST" action="{% url 'users:add_address' %}" class="p-8 space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Full Name</label>
                        <input type="text" name="full_name" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Phone</label>
                        <input type="tel" name="phone" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Address 1</label>
                        <input type="text" name="address_line_1" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Address 2</label>
                        <input type="text" name="address_line_2" class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Country</label>
                        <input type="text" name="country" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">State</label>
                        <input type="text" name="state" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">City</label>
                        <input type="text" name="city" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Zip Code</label>
                        <input type="text" name="postal_code" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" name="is_default" id="add_is_default" class="w-4 h-4 bg-black border-neutral-800 rounded focus:ring-white">
                    <label for="add_is_default" class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Set as default</label>
                </div>
                <div class="pt-6">
                    <button type="submit" class="w-full bg-white text-black font-black uppercase text-[11px] tracking-widest py-4 rounded-xl hover:bg-neutral-200 transition">Save Address</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT ADDRESS MODAL -->
<div id="editAddressModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-modal="true">
    <div class="fixed inset-0 bg-black/95 backdrop-blur-sm transition-opacity" onclick="closeModal('editAddressModal')"></div>
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="relative bg-neutral-950 border border-neutral-800 rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-8 border-b border-neutral-900 flex justify-between items-center">
                <h3 class="text-lg font-black uppercase tracking-tighter italic">Edit Location</h3>
                <button onclick="closeModal('editAddressModal')" class="text-neutral-500 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form method="POST" action="{% url 'users:edit_address' %}" class="p-8 space-y-6">
                {% csrf_token %}
                <input type="hidden" name="address_id" id="edit_address_id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Full Name</label>
                        <input type="text" name="full_name" id="edit_full_name" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Phone</label>
                        <input type="tel" name="phone" id="edit_phone" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Address 1</label>
                        <input type="text" name="address_line_1" id="edit_address_line_1" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="col-span-2 space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Address 2</label>
                        <input type="text" name="address_line_2" id="edit_address_line_2" class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Country</label>
                        <input type="text" name="country" id="edit_country" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">State</label>
                        <input type="text" name="state" id="edit_state" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">City</label>
                        <input type="text" name="city" id="edit_city" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black text-neutral-500 uppercase tracking-widest px-1">Zip Code</label>
                        <input type="text" name="postal_code" id="edit_postal_code" required class="w-full bg-black border border-neutral-800 rounded-xl px-4 py-3 text-sm text-neutral-300 focus:outline-none focus:border-white transition" />
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" name="is_default" id="edit_is_default" class="w-4 h-4 bg-black border-neutral-800 rounded focus:ring-white">
                    <label for="edit_is_default" class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Set as default</label>
                </div>
                <div class="pt-6">
                    <button type="submit" class="w-full bg-white text-black font-black uppercase text-[11px] tracking-widest py-4 rounded-xl hover:bg-neutral-200 transition">Update Address</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- DELETE MODAL -->
<div id="deleteAddressModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-modal="true">
    <div class="fixed inset-0 bg-black/95 backdrop-blur-sm transition-opacity" onclick="closeModal('deleteAddressModal')"></div>
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="relative bg-neutral-950 border border-neutral-800 rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden text-center p-8">
            <h3 class="text-lg font-black uppercase tracking-tighter italic mb-4">Confirm Removal</h3>
            <p class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest leading-loose mb-8 px-4">This address will be permanently removed from your account details.</p>
            <form method="POST" action="{% url 'users:delete_address' %}">
                {% csrf_token %}
                <input type="hidden" name="address_id" id="delete_address_id">
                <div class="flex flex-col gap-4">
                    <button type="submit" class="bg-rose-900/20 text-rose-500 border border-rose-900 font-black uppercase text-[10px] tracking-widest py-3 rounded-xl hover:bg-rose-500 hover:text-white transition">Delete Permanent</button>
                    <button type="button" onclick="closeModal('deleteAddressModal')" class="text-neutral-500 font-black uppercase text-[9px] tracking-widest hover:text-white transition">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openModal(id) {
        document.getElementById(id).classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function openEditModal(id, fullName, phone, addr1, addr2, city, state, zip, country, isDefault) {
        // Correct IDs (fixed the 'addrress' typo)
        document.getElementById("edit_address_id").value = id;
        document.getElementById("edit_full_name").value = fullName;
        document.getElementById("edit_phone").value = phone;
        document.getElementById("edit_address_line_1").value = addr1;
        document.getElementById("edit_address_line_2").value = (addr2 === 'None' || addr2 === '') ? "" : addr2;
        document.getElementById("edit_city").value = city;
        document.getElementById("edit_state").value = state;
        document.getElementById("edit_postal_code").value = zip;
        document.getElementById("edit_country").value = country;
        
        // Django renders booleans as 'True'/'False' strings
        document.getElementById("edit_is_default").checked = (isDefault === "True");

        openModal("editAddressModal");
    }

    function openDeleteModal(id) {
        document.getElementById('delete_address_id').value = id;
        openModal('deleteAddressModal');
    }
</script>
{% endblock %}